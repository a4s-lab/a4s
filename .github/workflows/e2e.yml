name: E2E Tests

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]
  workflow_dispatch:

jobs:
  e2e:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v5

      - name: Start infrastructure
        run: docker compose -f compose.dev.yml up -d --wait

      - name: Wait for API
        run: |
          for i in {1..30}; do
            curl -s http://localhost:8000/livez && break
            sleep 2
          done

      - name: Detect API key and run E2E tests
        env:
          GOOGLE_API_KEY: ${{ secrets.GOOGLE_API_KEY }}
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
          OPENROUTER_API_KEY: ${{ secrets.OPENROUTER_API_KEY }}
        run: |
          if [ -n "$GOOGLE_API_KEY" ]; then
            export MODEL_PROVIDER=google
            export MODEL_ID=gemini-3-flash-preview
          elif [ -n "$OPENAI_API_KEY" ]; then
            export MODEL_PROVIDER=openai
            export MODEL_ID=gpt-4o-mini
          elif [ -n "$OPENROUTER_API_KEY" ]; then
            export MODEL_PROVIDER=openrouter
            export MODEL_ID=google/gemini-3-flash-preview
          else
            echo "No API key found. Add one of: GOOGLE_API_KEY, OPENAI_API_KEY, OPENROUTER_API_KEY"
            exit 1
          fi
          echo "Using provider: $MODEL_PROVIDER with model: $MODEL_ID"
          ./e2e/run.sh --cleanup

      - name: Show logs on failure
        if: failure()
        run: docker compose -f compose.dev.yml logs
